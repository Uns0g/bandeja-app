<?php
session_start();

/* Conexão com o banco de dados */
include("../../classes/classeConexao.php");
$bancoDeDados = new BancoDeDados();

/* Variáveis opcionais ou indefinidas */
$tempo = $porcoes = $descricao = $fotoURL = NULL;

# se houver uma sessão de usuário ativa
if(isset($_SESSION["usuario"])){
	// Variáveis obrigatórias
	$titulo = $_POST["titulo"];
	$preparo = $_POST["preparo"];
	$autorDaReceita = $_SESSION["usuario"]["NOME"];

	// preenchendo variáveis opcionais
	if(!empty($_POST["tempo"])){ $tempo = $_POST["tempo"];}

	if(!empty($_POST["porcoes"])){ $porcoes = $_POST["porcoes"];}

	if(!empty($_POST["descricao"])){ $descricao = $_POST["descricao"];}
	
	# se a imagem não apresentar erro
	verificarValidadeDaImagem($_FILES["imagem"]);

	# mudando o valor de $autorDaReceita para receber o ID do usuario
	$SQL = "SELECT usuarioID FROM usuarios WHERE nome = '$autorDaReceita'";
	$resposta = $bancoDeDados->selecionar($SQL);
	$autorDaReceita = $resposta[0]["usuarioID"];

	/*if(isset($_POST["medidas"]) && isset($_POST["ingredientes"])){
		$medidas = $_POST["medidas"];
		$ingredientes = $_POST["ingredientes"];
	}
	else{
		voltarParaPaginaAnterior("cadastro-invalido",'NENHUM INGREDIENTE FOI CADASTRADO');
	}*/

	echo $fotoURL.'<br/>';
	$SQL = "INSERT INTO receitas(titulo,imagemURL,preparo,autor_ID) VALUES('$titulo','$fotoURL','$preparo',$autorDaReceita)";
	$resposta = $bancoDeDados->inserir($SQL);
	echo "INSERIDO NO BANCO DE DADOS!";
	// inserir no banco depois
}
else{
	header('Location: ../../erro/nenhum_usuario.php');
}

function verificarValidadeDaImagem($arquivoImagem){
	if($arquivoImagem["error"] == 0){
		$extensao = strtolower(pathinfo($arquivoImagem["name"], PATHINFO_EXTENSION));
		$extensoesValidas = array('gif','png','jpg','jpeg','jpe','jfif','heif','heic');

		# se o tamanho não for adequado
		if($arquivoImagem["size"]/1024 > 3072){
			voltarParaPaginaAnterior("imagem-invalida", 'O ARQUIVO NÃO PODE SER MAIOR QUE 3MB!');
		}
		else if(!in_array($extensao, $extensoesValidas)){ # se a extensão não for válida
			voltarParaPaginaAnterior("imagem-invalida", 'O ARQUIVO DEVE TER UMA EXTENSÃO VÁLIDA!');
		}
		else{ # caso tudo esteja certo
			$nomeDoAutor = str_replace(' ','-',$_SESSION["usuario"]["NOME"]);
			$receitaNaURL = tirarCaracteresLatinos(strtolower(str_replace(' ','_',$_POST["titulo"])));

			$fotoURL = 'imgs/receitas/'.$nomeDoAutor.'__'.$receitaNaURL.strval(rand(0,9999)).'.'.$extensao;
			if(move_uploaded_file($_FILES["imagem"]["tmp_name"], '../../'.$fotoURL)){
				echo "IMAGEM ENVIADA COM SUCESSO!<br/>";
			}
			else{
				echo "<strong style='color: #8C0303; text-align: center; display: block; font-size: 1.6em;'>OCORREU UM ERRO INESPERADO E A FOTO NÃO PÔDE SER ENVIADA AO SERVIDOR DE DESTINO!</strong><br/>";
				echo $destino;
			}
		}
	}
	else{
		voltarParaPaginaAnterior("imagem-invalida", 'OCORREU ALGUM ERRO AO ENVIAR A IMAGEM');
	}
}

function tirarCaracteresLatinos($texto) {
	return strtr(utf8_decode($texto),utf8_decode('àáâãäçèéêëìíîïñòóôõöùúûü'),'aaaaaceeeeiiiinooooouuuu');
}

function voltarParaPaginaAnterior($sessaoDeErro, $mensagem){
	$_SESSION[$sessaoDeErro] = $mensagem;
	echo '<b>'.$mensagem.'</b><br/>';
	// header('Location: ../../cadastrar_receita.php');
}

function buscarIDsDosIngredientes($ingredientes){
	$listaDeIDs = array();

	for($item = 0; $item < sizeof($ingredientes); $item++){
		$nomeDoIngrediente = $ingredientes[$item];

		$SQL = "SELECT ingredienteID FROM ingredientes WHERE nome = '$nomeDoIngrediente'";
		$resposta = $bancoDeDados->selecionar($SQL);

		array_push($listaDeIDs, $resposta[0]["ingredienteID"]);
	}

	return $listaDeIDs;
}
?>